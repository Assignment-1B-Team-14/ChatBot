matrix:
  include:
    - language: java
      sudo: required
      jdk: oraclejdk8
      before_script:
        - cd code/backend
      script:
        - sudo chmod +x mvnw
        - ./mvnw test
        - ./mvnw install

    - language: node_js
      sudo: required
      node_js:
      - "node"
      - "8"
      before_script:
        - cd code/frontend/web
      script:
        - npm install
        - npm test
        - npm run build

    - language: android
      sudo: required
      before_script:
        - cd code/frontend/mobile
        - nvm install 6
        - node --version        
      android:
        components:
          - build-tools-23.0.1
          - android-23
          - extra-android-m2repository
          - extra-google-google_play_services
          - extra-google-m2repository
          - addon-google_apis-google-16
      script:
        -  npm install
        - cd android && ./gradlew assembleRelease
before_deploy:
  - git config --local user.name "Florian Widder"
  - git config --local user.email "florian.widder@live.de"
  - git tag "$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)"

deploy:
  provider: releases
  api_key: "895ea69cba99f83eeabe7538489c4c023a0ebea3"
  file_glob: true
  file:
    - "code/frontend/mobile/android/app/build/outputs/apk/*"
    - "code/frontend/web/build/*"
    - "code/backend/build/*.jar"
  skip_cleanup: true

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  - .autoconf
  - $HOME/.m2
  - code/frontend/mobile/node_modules
  - code/frontend/web/node_modules
  - $HOME/.gradle/
  - $HOME/.android/build-cache

notifications:
  email:
    - florian.widder@live.de
